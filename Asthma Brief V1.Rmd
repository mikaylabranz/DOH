---
title: "Asthma Brief V1"
author: "MikaylaBranz"
date: "9/7/2020"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```
## Bring in the data
```{r}
#Install readr package to help import csv files
#install.packages("readr")

#Open readr package 
library(readr)

#Use readr to import csv files. 
asthma2014 <- read_csv("2014_Asthma.csv")
asthma2015 <- read_csv("2015_Asthma.csv")
asthma2016 <- read_csv("2016_Asthma.csv")
asthma2017 <- read_csv("2017_Asthma.csv")
asthma2018 <- read_csv("2018_Asthma.csv")
asthma2019 <- read_csv("2019_Asthma.csv")
asthma2020 <- read_csv("2020_Asthma_9-2.csv")
```
#combine into 1 dataset

```{r}
#load tidyverse
library(tidyverse)

#combine datasets

#make list of datasets to combine
asthmaAll <- list (asthma2014,
                asthma2015,
                asthma2016,
                asthma2017,
                asthma2018,
                asthma2019,
                asthma2020)

#combine elements in the list
asthma <- 
  asthmaAll %>%
  bind_rows()
```
# Trim dataset
```{r}
#select only variables that are relevant
asthma <- asthma %>% 
  select(Date, Zipcode,Age, Sex, Hospital,Race_flat,Ethnicity_Flat, HospitalName,HospitalZipCode,EssenceID, PIN, Time)

colnames(asthma)
```
# Clean Dataset
```{r}


#Separate "Date" into month, day, and year
asthma <- asthma %>%
  separate(col = Date, into = c("Month", "Day", "Year"), sep = "/", remove = FALSE)  

#Check and fix classes

class(asthma)
sapply(asthma,class)

asthma <- data.frame(asthma) 
asthma$Month <- as.numeric(asthma$Month)
asthma$Day <- as.numeric(asthma$Day)
asthma$Year <- as.numeric(asthma$Year)
asthma$Zipcode <- as.factor(asthma$Zipcode)
asthma$Age <- as.numeric(asthma$Age)
asthma$Sex <- as.factor(asthma$Sex)
asthma$Race_flat <- as.factor(asthma$Race_flat)
asthma$Ethnicity_Flat <- as.factor(asthma$Ethnicity_Flat)

#Recode Ethnicity
asthma <- asthma %>% 
  mutate(Ethnicity = recode(Ethnicity_Flat,
         ";Non-Hispanic;" = "NonHispanic", 
         ";NOT H;" = "NonHispanic", 
         ";Not H;" = "NonHispanic",
         ";Not Hispanic or Latino;" = "NonHispanic",
         
         ";Unknown;" = "UnknownOrNotReported",
         ";N;" = "UnknownOrNotReported", 
         ";U;" ="UnknownOrNotReported", 
         ";NR;" = "UnknownOrNotReported", 
         ";BL;" = "UnknownOrNotReported", 
         ";WH;" = "UnknownOrNotReported",
         
         ";Hispanic;" = "HispanicLatino",
         ";Hispa;" = "HispanicLatino", 
         ";H;" = "HispanicLatino",
         ";Hispanic or Latino;" = "HispanicLatino")) 

#Recode Race
asthma <- asthma %>% 
  mutate(Race = recode(Race_flat,
                       ";Black;" = "BlackOrAfricanAmerican",
                       ";B;" = "BlackOrAfricanAmerican",
                       ";Black or African American;" = "BlackOrAfricanAmerican",
                       ";Black or African American;Black or African American;" = "BlackOrAfricanAmerican",
                       
                       ";White;" = "White",
                       ";W;" = "White",
                       
                       ";Other;" = "Other",
                       ";Ameri;" = "Other",
                       ";O;" = "Other",
                       ";Other Race;" = "Other",
                       ";Other Race;Other Race;" = "Other",
                       
                       ";Unknown;" = "Unknown",
                       ";NR;" = "Unknown",
                       ";U;" = "Unknown",
                       
                       ";Asian or Pacific Islander;" = "AsianOrPacificIslander",
                       ";Asian;" = "AsianOrPacificIslander",
                       ";A;" = "AsianOrPacificIslander",
                       ";Native hawaiian or Other Pacific Islander;" = "AsianOrPacificIslander",
                       
                       ";American Indian or Alaskan Native;" = "AmericanIndianOrAlaskaNative",
                       ";Nativ;" = "AmericanIndianOrAlaskaNative",
                       ";American Indian or Alaska Native;" = "AmericanIndianOrAlaskaNative",
                       
                       ";M;" = "MixedRace",
                       ";White;Black or African American;" = "MixedRace",
                       ";Black or African American;White;" = "MixedRace",
                       ";Other Race;White;" = "MixedRace")) %>% 

  mutate(RaceCondensed = recode(Race, 
                               "BlackOrAfricanAmerican" = "Black",
                               "White" = "White",
                               "Other" = "Other",
                               "Unknown" = "Other",
                               "AsianOrPacificIslander" = "Other",
                               "AmericanIndianOrAlaskaNative" = "Other",
                               "MixedRace" = "Other"))

#Remove case with impossible age (117)
asthma <- asthma %>% 
  filter(Age != "117")

#remove any duplicates in data
asthma <- distinct(asthma, .keep_all = FALSE)

dim(asthma)

#note: there are 30 something na's for age
```
#start to graph things
```{r}
library(ggplot2)

#change order of race
#check levels
levels(asthma$RaceCondensed)
#make a list with new order of levels
 newlevel <- c("Black", "White","Other")
 #change the order of the levels in race
 asthma$RaceCondensed <- factor(asthma$RaceCondensed, levels = newlevel)

#Graph the total number of cases by race, over time. Only include Jan-August so that it is comparable to 2020
asthma %>% 
  filter(Month < 9) %>% 
  group_by(RaceCondensed, Year) %>% 
  summarise(total = n()) %>% 
  ggplot() +
   geom_line(aes(x = Year, y = total, color = RaceCondensed), size = 1) +
  labs(y="Cases", x = "Year", color = "Race") +
   theme(axis.text.x=element_text(angle=45,  hjust = 1)) +
    scale_x_continuous(breaks = seq(2014,2020, by =1))+
   theme(panel.grid.minor.x=element_blank())+
  ggtitle("Asthma Hospitalization Cases by Race (Jan-Aug), 2014-2020")


#Graph the total number of cases by zipcode in 2019
asthma %>% 
  filter(Year==2019) %>% 
  group_by(Zipcode) %>% 
summarise(total = n()) %>% 
  arrange(total) %>% 
  ggplot() +
   geom_col(aes(x = reorder(Zipcode, -total), y= total, dodge = TRUE), fill= "Maroon") +
  theme(axis.text.x=element_text(angle=45, hjust=1), legend.position = "none") +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,300)) +
  labs(y="Cases", x = "Zip Code")+
  ggtitle("Asthma Hospitalization Cases by Zip Code, Jan.- Dec. 2019")
asthma %>% 
  filter(Year==2020) %>% 
  group_by(Zipcode) %>% 
summarise(total = n()) %>% 
  arrange(total) %>% 
  ggplot() +
   geom_col(aes(x = reorder(Zipcode, -total), y= total, dodge = TRUE), fill = "Maroon") +
  theme(axis.text.x=element_text(angle=45,hjust=1,), legend.position = "none") +
    scale_y_continuous(expand = c(0,0), limits = c(0,150)) +
  labs(y="Cases", x = "Zip Code")+
  ggtitle("Asthma Hospitalization Cases by Zip Code, Jan.-Aug. 2020")


 
 #Now figure out how to do it as a proportion of the population.





```















## Explore the data
```{r}


#Recode age into different categories
asthma <- asthma %>% 
  mutate(AgeGroup =  if_else(Age %in% 0:9, "0-9",
                     ifelse(Age %in% 10:19, "10-19",
                     ifelse(Age %in% 20:29, "20-29",
                     ifelse(Age %in% 30:39, "30-39",
                     ifelse(Age %in% 40:49, "40-49",
                     ifelse(Age %in% 50:59, "50-59",
                     ifelse(Age %in% 60:69, "60-69",
                     ifelse(Age %in% 70:79, "70-79",
                     ifelse(Age >= 80, "80+", "NA"))))))))))

#make AgeGroup factor variable
asthma$AgeGroup<-as.factor(asthma$AgeGroup)

asthma <- asthma %>% 
  mutate(AgeGroupPractical =  
                     if_else(Age %in% 0:5, "0-5",
                     ifelse(Age %in% 6:10, "6-10",
                     ifelse(Age %in% 11:14, "11-14",
                     ifelse(Age %in% 15:18, "15-18",
                     ifelse(Age %in% 19:26, "19-26",
                     ifelse(Age %in% 27:39, "27-39",
                     ifelse(Age %in% 40:59, "40-59",
                     ifelse(Age %in% 60:79, "60-79",
                     ifelse(Age >= 80, "80+", "NA"))))))))))
levels(asthma$AgeGroup)
       

```
 